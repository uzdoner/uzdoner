<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Secure Checkout | Uz Doner</title>
  <meta name="theme-color" content="#111827"/>
  <link rel="icon" href="/uzdoner-Logo%20(1).png"/>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f6f7f9; }
    .wrap { max-width: 720px; margin: 20px auto; padding: 12px; }
    .card { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.04); overflow:hidden; }
    .p16 { padding: 16px; }
    h1 { font-size: clamp(20px, 3.4vw, 28px); margin: 0 0 8px; font-weight: 800; line-height:1.2; }
    .muted { color:#64748b; font-size:14px; }
    .form { display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    @media (min-width: 640px) { .form.two { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:12px; font-weight:700; color:#111; margin-bottom:6px; }
    input[type="text"], input[type="email"], input[type="tel"] {
      width:100%; height:44px; padding:10px 12px; border:1px solid rgba(0,0,0,.14); border-radius:12px; font-size:14px; background:#fff;
    }
    /* Clover Elements containers â€” compact and responsive */
    .box {
      width:100%; height:44px; border:1px solid rgba(0,0,0,.14);
      border-radius:12px; background:#fff; padding:0 12px; display:flex; align-items:center;
    }
    /* Make embedded iframes fill the input height neatly */
    .box iframe { width:100% !important; height:100% !important; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width: 480px) { .row-3 { grid-template-columns: 1fr 1fr; } .row-3 .full { grid-column: 1 / -1; } }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-top:1px solid rgba(0,0,0,.06); background:#fafafa; }
    .total { font-size:18px; font-weight:800; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 18px; border-radius:12px; border:0; background:#111; color:#fff; font-weight:800; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .err { color:#b91c1c; font-size:13px; margin-top:8px; display:none; }
    .ok  { color:#065f46; font-size:13px; margin-top:8px; display:none; }
  </style>
  <!-- Clover SDK (PRODUCTION) -->
  <script src="https://checkout.clover.com/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="p16">
        <h1>Complete your payment securely ðŸ”’</h1>
        <p class="muted">Cards are processed by Clover over a PCI-compliant connection.</p>

        <!-- Customer info -->
        <div class="form two">
          <div>
            <label for="firstName">First name</label>
            <input id="firstName" autocomplete="given-name" type="text" placeholder="Sherali" required>
          </div>
          <div>
            <label for="lastName">Last name</label>
            <input id="lastName" autocomplete="family-name" type="text" placeholder="Islomov" required>
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" autocomplete="email" type="email" placeholder="you@example.com" required>
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" autocomplete="tel" inputmode="tel" type="tel" placeholder="(929) 000-0000">
          </div>
        </div>

        <!-- Card fields -->
        <div class="form" style="margin-top:14px">
          <div>
            <label>Card Number</label>
            <div id="clover-card-number" class="box"></div>
          </div>

          <div class="row-3">
            <div>
              <label>MM/YYYY</label>
              <div id="clover-card-date" class="box"></div>
            </div>
            <div>
              <label>CVV</label>
              <div id="clover-card-cvv" class="box"></div>
            </div>
            <div class="full">
              <label>Zip</label>
              <div id="clover-card-postalCode" class="box"></div>
            </div>
          </div>
        </div>

        <div id="msgErr" class="err"></div>
        <div id="msgOk"  class="ok"></div>
      </div>

      <div class="bar">
        <div><span class="muted">Order total:</span> <span class="total" id="total">$0.00</span></div>
        <button id="payNow" class="btn">Pay now</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIGURATION ====== */
const CLOVER_PUBLISHABLE_KEY = 'abc5e72c9169c34cb722402a448c51c9'; // public token (iFrame)
const BACKEND_BASE = 'https://uzdoner-pay.uzdonerweb.workers.dev';   // Worker backend URL
/* ============================ */

/* Cart total: localStorage('cart') = [{price:13.99, qty:2}, ...] */
const TAX_RATE = 0.08875; // 8.875% â€“ NYC
function money(n){ return `$${n.toFixed(2)}`; }
function getCartTotalCents(){
  let cart = [];
  try{ cart = JSON.parse(localStorage.getItem('cart') || '[]'); }catch(e){}
  const subtotal = cart.reduce((s,it)=> s + (Number(it.price)||0) * (Number(it.qty)||0), 0);
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;
  return Math.round(total * 100); // cents
}

const els = {
  total: document.getElementById('total'),
  payNow: document.getElementById('payNow'),
  err: document.getElementById('msgErr'),
  ok:  document.getElementById('msgOk'),
  first: document.getElementById('firstName'),
  last:  document.getElementById('lastName'),
  email: document.getElementById('email'),
  phone: document.getElementById('phone'),
};

let clover, elements, cn, exp, cvv, postal;

function mountClover(){
  try{
    clover = new Clover(CLOVER_PUBLISHABLE_KEY);
    elements = clover.elements();

    // Compact styling
    const style = { base: { fontSize: '14px', '::placeholder': { color:'#9aa3af' } } };

    // IMPORTANT: API element names must match worker version
    cn     = elements.create('CARD_NUMBER',      { style }); cn.mount('#clover-card-number');
    exp    = elements.create('CARD_DATE',        { style }); exp.mount('#clover-card-date');
    cvv    = elements.create('CARD_CVV',         { style }); cvv.mount('#clover-card-cvv');
    postal = elements.create('CARD_POSTAL_CODE', { style }); postal.mount('#clover-card-postalCode');
  }catch(e){
    showErr('Clover SDK yuklanmadi: ' + (e.message||e));
    els.payNow.disabled = true;
  }
}

function showErr(t){ els.err.textContent = t; els.err.style.display = 'block'; }
function clearErr(){ els.err.textContent = ''; els.err.style.display = 'none'; }
function showOk(t){ els.ok.textContent = t; els.ok.style.display = 'block'; }

async function charge(){
  clearErr(); els.ok.style.display='none';
  const amount = getCartTotalCents();
  if(!amount || amount < 50){ showErr('Amount is invalid.'); return; }

  els.payNow.disabled = true; els.payNow.textContent = 'Processingâ€¦';
  try{
    const { token, errors } = await clover.createToken();
    if(errors){ throw new Error(Object.values(errors).map(e=>e.message||e).join(' ')); }
    if(!token){ throw new Error('Tokenization failed'); }

    const res = await fetch(`${BACKEND_BASE}/charge`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        token,
        amount,
        currency: 'USD',
        description: 'Online order (Uz Doner website)',
        customer: {
          firstName: els.first.value,
          lastName:  els.last.value,
          email:     els.email.value,
          phone:     els.phone.value
        },
        cart: (JSON.parse(localStorage.getItem('cart')||'[]'))
      })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){ throw new Error(data.error || 'Payment failed'); }

    localStorage.removeItem('cart');
    showOk('Payment successful! Order #' + (data.orderId||''));
    setTimeout(()=> window.location.href = '/thank-you', 800);
  }catch(err){
    showErr(err.message || 'Payment error');
  }finally{
    els.payNow.disabled = false; els.payNow.textContent = 'Pay now';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  els.total.textContent = money(getCartTotalCents()/100);
  mountClover();
  els.payNow.addEventListener('click', charge);

  // Enter bosilganda form submit bo'lib ketmasin
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') e.preventDefault();
  });
});
</script>
</body>
</html>
