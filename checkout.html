<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Secure Checkout | Uz Doner</title>
  <meta name="theme-color" content="#111827"/>
  <link rel="icon" href="/uzdoner-Logo%20(1).png"/>
  <style>
    :root { color-scheme: light; }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.04)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .p16{padding:16px}
    h1{font-size:24px;margin:0 0 6px;font-weight:800}
    .muted{color:#64748b;font-size:14px}
    label{display:block;font-size:12px;font-weight:700;color:#111;margin-top:10px}
    input{width:100%;padding:10px 12px;border:1px solid rgba(0,0,0,.15);border-radius:10px;font-size:14px}
    .inline{display:flex;align-items:center;gap:8px}
    .total{font-size:18px;font-weight:800}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .bar{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-top:1px solid rgba(0,0,0,.06);background:#fafafa;border-radius:0 0 16px 16px}
    .err{color:#b91c1c;font-size:13px;margin-top:8px;display:none}
    .ok{color:#065f46;font-size:13px;margin-top:8px;display:none}
    .payrow{display:grid;grid-template-columns:1fr;gap:10px}
    .box{border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:10px 12px;background:#fff}
  </style>
  <!-- Clover SDK (PRODUCTION!) -->
  <script src="https://checkout.clover.com/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="p16">
        <h1>Complete your payment securely üçî</h1>
        <p class="muted">Cards are processed by Clover over a PCI-compliant connection.</p>

        <!-- Customer -->
        <div class="row">
          <div>
            <label>First name</label>
            <input id="firstName" placeholder="Ali" required>
          </div>
          <div>
            <label>Last name</label>
            <input id="lastName" placeholder="Karimov" required>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" required>
          </div>
          <div>
            <label>Phone</label>
            <input id="phone" placeholder="(929) 000-0000">
          </div>
        </div>

        <!-- Card fields (Clover Elements) -->
        <label style="margin-top:14px">Card details</label>
        <div class="payrow">
          <div id="clover-card-number" class="box"></div>
          <div class="row">
            <div id="clover-card-date" class="box"></div>
            <div id="clover-card-cvv" class="box"></div>
            <div id="clover-card-postalCode" class="box"></div>
          </div>
        </div>

        <div id="msgErr" class="err"></div>
        <div id="msgOk" class="ok"></div>
      </div>

      <div class="bar">
        <div class="inline">
          <span>Order total:</span>
          <span class="total" id="total">$0.00</span>
        </div>
        <button id="payNow" class="btn">Pay now</button>
      </div>
    </div>

    <p class="muted" style="margin:16px">Tip: bu sahifani **/checkout.html** sifatida GitHub Pages‚Äôda joylang. Worker backend URL‚Äôi va Clover public token to‚Äòg‚Äòri bo‚Äòlishi shart.</p>
  </div>

<script>
/* ========= CONFIGURATION ========= */
const CLOVER_PUBLISHABLE_KEY = 'abc5e72c9169c34cb722402a448c51c9'; // siz bergan public token
const BACKEND_BASE = 'https://uzdoner-pay.uzdonerweb.workers.dev'; // Worker URL (orqadagi server)
/* ================================= */

/* Example: total summani o‚Äòzingiz belgilaysiz */
const TAX_RATE = 0.08875; // NYC misol
function money(n){ return `$${n.toFixed(2)}`; }
function getCartTotalCents(){
  let cart = [];
  try{ cart = JSON.parse(localStorage.getItem('cart') || '[]'); }catch(e){}
  const subtotal = cart.reduce((s,it)=> s + it.price*it.qty, 0);
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;
  return Math.round(total * 100); // sentlarda
}

const els = {
  total: document.getElementById('total'),
  payNow: document.getElementById('payNow'),
  err: document.getElementById('msgErr'),
  ok: document.getElementById('msgOk'),
  first: document.getElementById('firstName'),
  last: document.getElementById('lastName'),
  email: document.getElementById('email'),
  phone: document.getElementById('phone'),
};

let clover, elements, cn, exp, cvv, postal;
function mountClover(){
  try{
    clover = new Clover(CLOVER_PUBLISHABLE_KEY);
    elements = clover.elements();
    cn = elements.create('cardNumber');     cn.mount('#clover-card-number');
    exp = elements.create('cardDate');      exp.mount('#clover-card-date');
    cvv = elements.create('cardCvv');       cvv.mount('#clover-card-cvv');
    postal = elements.create('postalCode'); postal.mount('#clover-card-postalCode');
  }catch(e){
    showErr('Clover SDK yuklanmadi: ' + (e.message||e));
  }
}

function showErr(t){ els.err.textContent = t; els.err.style.display = 'block'; }
function clearErr(){ els.err.textContent = ''; els.err.style.display = 'none'; }
function showOk(t){ els.ok.textContent = t; els.ok.style.display = 'block'; }

async function charge(){
  clearErr(); els.ok.style.display='none';
  const amount = getCartTotalCents();
  if(!amount || amount < 50){ showErr('Noto‚Äòg‚Äòri summa.'); return; }

  els.payNow.disabled = true; els.payNow.textContent = 'Processing‚Ä¶';
  try{
    // 1) Tokenize card
    const { token, errors } = await clover.createToken();
    if(errors){ throw new Error(Object.values(errors).map(e=>e.message||e).join(' ')); }
    if(!token){ throw new Error('Tokenization failed'); }

    // 2) Serverga yuborish
    const res = await fetch(`${BACKEND_BASE}/charge`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        token,
        amount,
        currency: 'USD',
        description: 'Online order (UzDoner website)',
        customer: {
          firstName: els.first.value,
          lastName: els.last.value,
          email: els.email.value,
          phone: els.phone.value
        },
        cart: (JSON.parse(localStorage.getItem('cart')||'[]'))
      })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){ throw new Error(data.error || 'Payment failed'); }

    // 3) Success
    localStorage.removeItem('cart');
    showOk('Payment successful! Order #' + (data.orderId||''));
    setTimeout(()=> window.location.href = '/thank-you', 800);
  }catch(err){
    showErr(err.message || 'Payment error');
  }finally{
    els.payNow.disabled = false; els.payNow.textContent = 'Pay now';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  els.total.textContent = money(getCartTotalCents()/100);
  mountClover();
  els.payNow.addEventListener('click', charge);
});
</script>
</body>
</html>
