<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Secure Checkout | Uz Doner</title>
  <meta name="theme-color" content="#111827"/>
  <link rel="icon" href="/uzdoner-Logo%20(1).png"/>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f6f7f9; }
    .wrap { max-width: 720px; margin: 20px auto; padding: 12px; }
    .card { background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.04); overflow:hidden; }
    .p16 { padding: 16px; }
    h1 { font-size: clamp(20px, 3.4vw, 28px); margin: 0 0 8px; font-weight: 800; line-height:1.2; }
    .muted { color:#64748b; font-size:14px; }
    .form { display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    @media (min-width: 640px) { .form.two { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:12px; font-weight:700; color:#111; margin-bottom:6px; }
    input[type="text"], input[type="email"], input[type="tel"] {
      width:100%; height:44px; padding:10px 12px; border:1px solid rgba(0,0,0,.14); border-radius:12px; font-size:14px; background:#fff;
    }
    .bar { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-top:1px solid rgba(0,0,0,.06); background:#fafafa; }
    .total { font-size:18px; font-weight:800; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 18px; border-radius:12px; border:0; background:#111; color:#fff; font-weight:800; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .err { color:#b91c1c; font-size:13px; margin-top:8px; display:none; }
    .ok  { color:#065f46; font-size:13px; margin-top:8px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="p16">
        <h1>Complete your payment securely ðŸ”’</h1>
        <p class="muted">Cards are processed by Clover on a PCI-compliant hosted page.</p>

        <!-- Customer info (ixtiyoriy, biz faqat URLga joâ€˜natamiz yoki orderga saqlamoqchi boâ€˜lsangiz Workerâ€™ga yuborasiz) -->
        <div class="form two">
          <div>
            <label for="firstName">First name</label>
            <input id="firstName" type="text" placeholder="Sherali">
          </div>
          <div>
            <label for="lastName">Last name</label>
            <input id="lastName" type="text" placeholder="Islomov">
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com">
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" type="tel" placeholder="(929) 000-0000">
          </div>
        </div>

        <div id="msgErr" class="err"></div>
        <div id="msgOk"  class="ok"></div>
      </div>

      <div class="bar">
        <div><span class="muted">Order total:</span> <span class="total" id="total">$0.00</span></div>
        <button id="payHosted" class="btn">Pay on Clover</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
/** Siz yaratgan Clover Hosted link (pay-widgets) â€” siz bergansiz */
const HOSTED_URL = "https://www.clover.com/pay-widgets/ba534d03-764f-4a58-bf17-c4e8d1490fbb";

/** Agar Worker orqali redirect qilmoqchi boâ€˜lsangiz, backend bazani kiriting.
    Aks holda WORKER_BASE ni boâ€˜sh qoldiring va toâ€˜gâ€˜ridan-toâ€˜gâ€˜ri HOSTED_URL ga redirect qilamiz. */
const WORKER_BASE = ""; // masalan: 'https://uzdoner-pay.uzdonerweb.workers.dev'

/** Soliq hisoblash (cart ichida localStorage bilan xuddi oldingidek) */
const TAX_RATE = 0.08875; // 8.875% (NYC misol)

function money(n){ return `$${n.toFixed(2)}`; }

function getCart(){
  try{ return JSON.parse(localStorage.getItem('cart') || '[]'); }catch(e){ return []; }
}

function getTotalCents(){
  const cart = getCart();
  const subtotal = cart.reduce((s,it)=> s + (Number(it.price)||0) * (Number(it.qty)||0), 0);
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;
  return Math.round(total * 100);
}

const els = {
  total: document.getElementById('total'),
  btn: document.getElementById('payHosted'),
  err: document.getElementById('msgErr'),
  ok:  document.getElementById('msgOk'),
  first: document.getElementById('firstName'),
  last:  document.getElementById('lastName'),
  email: document.getElementById('email'),
  phone: document.getElementById('phone'),
};

function showErr(t){ els.err.textContent = t; els.err.style.display = 'block'; }
function clearErr(){ els.err.textContent = ''; els.err.style.display = 'none'; }
function showOk(t){ els.ok.textContent = t; els.ok.style.display = 'block'; }

async function goHosted(){
  clearErr(); els.ok.style.display='none';

  const amountCents = getTotalCents();
  if(!amountCents || amountCents < 50){ showErr('Total amount is invalid.'); return; }

  // Mijoz maâ€™lumotlari (ixtiyoriy) â€“ agar Workerâ€™ga yubormoqchi boâ€˜lsangiz
  const customer = {
    firstName: els.first.value || '',
    lastName:  els.last.value  || '',
    email:     els.email.value || '',
    phone:     els.phone.value || ''
  };

  // 1) WORKER orqali redirect (ixtiyoriy)
  if (WORKER_BASE) {
    els.btn.disabled = true; els.btn.textContent = 'Redirectingâ€¦';
    try{
      const r = await fetch(`${WORKER_BASE}/hosted/create`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          amount: amountCents,
          currency: 'USD',
          cart: getCart(),
          customer
        })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok || !data.ok || !data.url){ throw new Error(data.error || 'Failed to get hosted URL'); }
      window.location.href = data.url;
    }catch(e){
      els.btn.disabled = false; els.btn.textContent = 'Pay on Clover';
      showErr(e.message || 'Redirect error');
    }
    return;
  }

  // 2) Toâ€˜gâ€˜ridan-toâ€˜gâ€˜ri Clover hosted linkiga redirect
  // Baâ€™zi widgetlar ?amount=12.34 yoki ?amountInCents=1234â€™ni qabul qiladi.
  // Biz ikkisini ham qoâ€˜shamiz â€” qaysi biri ishlasa, oâ€˜sha oladi; ishlamasa, sahifada mijoz summa kiritadi.
  const amountParam = (amountCents/100).toFixed(2); // 12.34
  const url = new URL(HOSTED_URL);
  url.searchParams.set('amount', amountParam);
  url.searchParams.set('amountInCents', String(amountCents));

  // Shuningdek mijoz infoâ€™ni ham qoâ€˜shib yuboramiz (agar vidjet oâ€˜qisa):
  if(customer.firstName) url.searchParams.set('firstName', customer.firstName);
  if(customer.lastName)  url.searchParams.set('lastName',  customer.lastName);
  if(customer.email)     url.searchParams.set('email',     customer.email);
  if(customer.phone)     url.searchParams.set('phone',     customer.phone);

  // Cartni keyingi sahifalar uchun kerak boâ€˜lsa saqlab qoâ€˜ying
  sessionStorage.setItem('last_checkout_total_cents', String(amountCents));

  window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', ()=>{
  els.total.textContent = money(getTotalCents()/100);
  els.btn.addEventListener('click', goHosted);
});
</script>
</body>
</html>
